<template>
  <div id="app">
    <router-view v-if="isReady" />
    <div v-else class="loading-container">
      <div class="loading-content">
        <el-icon class="loading-icon" :size="60" color="#409EFF">
          <Loading />
        </el-icon>
        <h2 class="loading-title">QR ÏïàÏ†ÑÍµêÏú°</h2>
        <p class="loading-text">{{ loadingMessage }}</p>
        <div class="loading-progress">
          <el-progress :percentage="loadingProgress" :show-text="false" />
        </div>
      </div>
    </div>

    <!-- Ïò§ÌîÑÎùºÏù∏ ÏïåÎ¶º -->
    <el-alert
      v-if="showOfflineAlert"
      title="ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÎÅäÍπÄ"
      description="Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. ÏùºÎ∂Ä Í∏∞Îä•Ïù¥ Ï†úÌïúÎê† Ïàò ÏûàÏäµÎãàÎã§."
      type="warning"
      :closable="false"
      show-icon
      class="offline-alert"
    />

    <!-- ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º -->
    <el-notification
      v-if="showUpdateNotification"
      title="Ïï± ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º"
      message="ÏÉàÎ°úÏö¥ Î≤ÑÏ†ÑÏù¥ ÏûàÏäµÎãàÎã§. ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏÑ∏Ïöî."
      type="info"
      :duration="0"
      @close="showUpdateNotification = false"
    >
      <template #default>
        <div style="margin-top: 10px;">
          <el-button size="small" type="primary" @click="reloadApp">
            ÏßÄÍ∏à ÏóÖÎç∞Ïù¥Ìä∏
          </el-button>
          <el-button size="small" @click="showUpdateNotification = false">
            ÎÇòÏ§ëÏóê
          </el-button>
        </div>
      </template>
    </el-notification>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { initializeFirebase, checkNetworkStatus } from '@/services/firebase'
import { Loading } from '@element-plus/icons-vue'
import { ElNotification } from 'element-plus'

// Ïª¥Ìè¨ÎÑåÌä∏ ÏÉÅÌÉú
const isReady = ref(false)
const loadingMessage = ref('Ïï±ÏùÑ Ï¥àÍ∏∞ÌôîÌïòÎäî Ï§ë...')
const loadingProgress = ref(0)
const showOfflineAlert = ref(false)
const showUpdateNotification = ref(false)

// Ïä§ÌÜ†Ïñ¥
const authStore = useAuthStore()

// ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú ÌôïÏù∏
let networkCheckInterval: number | null = null

const checkNetworkConnection = async () => {
  const isOnline = await checkNetworkStatus()
  showOfflineAlert.value = !isOnline
}

// Ïï± Ï¥àÍ∏∞Ìôî
const initializeApp = async () => {
  try {
    console.log('üöÄ QR ÏïàÏ†ÑÍµêÏú° Ïï± Ï¥àÍ∏∞Ìôî ÏãúÏûë...')

    // 1Îã®Í≥Ñ: Firebase Ï¥àÍ∏∞Ìôî (30%)
    loadingMessage.value = 'Firebase Ïó∞Í≤∞ Ï§ë...'
    loadingProgress.value = 10

    const firebaseInitialized = await initializeFirebase()

    if (!firebaseInitialized) {
      console.warn('‚ö†Ô∏è Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®, Ïò§ÌîÑÎùºÏù∏ Î™®ÎìúÎ°ú ÏßÑÌñâ')
      loadingMessage.value = 'Ïò§ÌîÑÎùºÏù∏ Î™®ÎìúÎ°ú ÏãúÏûë...'
      showOfflineAlert.value = true
    } else {
      console.log('‚úÖ Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å')
      loadingMessage.value = 'Firebase Ïó∞Í≤∞ ÏôÑÎ£å'
    }

    loadingProgress.value = 30
    await new Promise(resolve => setTimeout(resolve, 500))

    // 2Îã®Í≥Ñ: Ïù∏Ï¶ù ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (60%)
    if (firebaseInitialized) {
      loadingMessage.value = 'ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù ÌôïÏù∏ Ï§ë...'
      loadingProgress.value = 40

      try {
        await authStore.initializeAuth()
        console.log('‚úÖ Ïù∏Ï¶ù ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å')

        if (authStore.isLoggedIn) {
          loadingMessage.value = `${authStore.displayName}Îãò, ÌôòÏòÅÌï©ÎãàÎã§!`
        } else {
          loadingMessage.value = 'Ïù∏Ï¶ù Ï¥àÍ∏∞Ìôî ÏôÑÎ£å'
        }
      } catch (authError) {
        console.warn('‚ö†Ô∏è Ïù∏Ï¶ù Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', authError)
        loadingMessage.value = 'Ïù∏Ï¶ù Ï¥àÍ∏∞Ìôî Ïã§Ìå®, Í≥ÑÏÜç ÏßÑÌñâ...'
      }
    }

    loadingProgress.value = 60
    await new Promise(resolve => setTimeout(resolve, 500))

    // 3Îã®Í≥Ñ: Ïï± Î≥¥Ïïà Í≤ÄÏÇ¨ (80%)
    loadingMessage.value = 'Î≥¥Ïïà Í≤ÄÏÇ¨ Ï§ë...'
    loadingProgress.value = 70

    // TODO: [Î≥¥ÏïàÍ∞ïÌôî] Ïï± Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù
    // - Ïï± ÏÑúÎ™Ö Í≤ÄÏ¶ù
    // - Î£®ÌåÖ/ÌÉàÏò• ÎîîÎ∞îÏù¥Ïä§ Í∞êÏßÄ
    // - ÎîîÎ≤ÑÍπÖ ÎèÑÍµ¨ Í∞êÏßÄ
    await performSecurityChecks()

    loadingProgress.value = 80
    await new Promise(resolve => setTimeout(resolve, 300))

    // 4Îã®Í≥Ñ: ÏµúÏ¢Ö Ï§ÄÎπÑ (100%)
    loadingMessage.value = 'Ï§ÄÎπÑ ÏôÑÎ£å!'
    loadingProgress.value = 90

    // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë
    if (firebaseInitialized) {
      startNetworkMonitoring()
    }

    // ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù (PWA ÏßÄÏõê)
    await registerServiceWorker()

    loadingProgress.value = 100
    await new Promise(resolve => setTimeout(resolve, 500))

    isReady.value = true
    console.log('üéâ QR ÏïàÏ†ÑÍµêÏú° Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å')

  } catch (error) {
    console.error('‚ùå Ïï± Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error)

    // Ïò§Î•ò Î∞úÏÉù ÏãúÏóêÎèÑ Ïï± ÏßÑÌñâ (ÏïàÏ†Ñ Ïû•Ïπò)
    loadingMessage.value = 'Ï¥àÍ∏∞Ìôî ÏôÑÎ£å (ÏùºÎ∂Ä Ï†úÌïú)'
    loadingProgress.value = 100

    // TODO: [Î≥¥ÏïàÍ∞ïÌôî] Ï¥àÍ∏∞Ìôî Ïã§Ìå® Ïãú ÏïàÏ†ÑÌïú Ï≤òÎ¶¨
    // - ÎØºÍ∞êÌïú Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º Ï∞®Îã®
    // - Ïò§Î•ò Î≥¥Í≥† (ÎØºÍ∞êÌïú Ï†ïÎ≥¥ Ï†úÏô∏)

    await new Promise(resolve => setTimeout(resolve, 1000))
    isReady.value = true
  }
}

// Î≥¥Ïïà Í≤ÄÏÇ¨
const performSecurityChecks = async () => {
  try {
    // Í∏∞Î≥∏ Î≥¥Ïïà Í≤ÄÏÇ¨Îì§
    const checks = [
      checkDeviceIntegrity(),
      checkAppIntegrity(),
      checkRuntimeSecurity()
    ]

    await Promise.allSettled(checks)
    console.log('‚úÖ Î≥¥Ïïà Í≤ÄÏÇ¨ ÏôÑÎ£å')
  } catch (error) {
    console.warn('‚ö†Ô∏è Î≥¥Ïïà Í≤ÄÏÇ¨ Ï§ë Ïò§Î•ò:', error)
  }
}

// ÎîîÎ∞îÏù¥Ïä§ Î¨¥Í≤∞ÏÑ± Í≤ÄÏÇ¨
const checkDeviceIntegrity = async () => {
  // TODO: ÎÑ§Ïù¥Ìã∞Î∏å Î∏åÎ¶¨ÏßÄÎ•º ÌÜµÌïú ÎîîÎ∞îÏù¥Ïä§ Î≥¥Ïïà ÏÉÅÌÉú ÌôïÏù∏
  // - Î£®ÌåÖ/ÌÉàÏò• Ïó¨Î∂Ä
  // - ÎîîÎ≤ÑÍπÖ Î™®Îìú Ïó¨Î∂Ä
  // - ÏóêÎÆ¨Î†àÏù¥ÌÑ∞ Ïó¨Î∂Ä

  // ÏûÑÏãú Íµ¨ÌòÑ (Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤Ω)
  const userAgent = navigator.userAgent
  if (userAgent.includes('Chrome-Lighthouse') ||
    userAgent.includes('HeadlessChrome')) {
    console.warn('‚ö†Ô∏è ÏûêÎèôÌôî ÎèÑÍµ¨ Í∞êÏßÄÎê®')
  }
}

// Ïï± Î¨¥Í≤∞ÏÑ± Í≤ÄÏÇ¨
const checkAppIntegrity = async () => {
  // TODO: Ïï± ÏÑúÎ™Ö Î∞è ÏΩîÎìú Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù
  // - Ìï¥Ïãú Í≤ÄÏ¶ù
  // - Î≤àÎì§ Î¨¥Í≤∞ÏÑ± ÌôïÏù∏

  console.log('üì± Ïï± Î¨¥Í≤∞ÏÑ± Í≤ÄÏÇ¨ ÏàòÌñâÎê®')
}

// Îü∞ÌÉÄÏûÑ Î≥¥Ïïà Í≤ÄÏÇ¨
const checkRuntimeSecurity = async () => {
  // Í∞úÎ∞úÏûê ÎèÑÍµ¨ Í∞êÏßÄ (Í∞ÑÎã®Ìïú Î∞©Î≤ï)
  let devtools = {
    open: false,
    orientation: null as string | null
  }

  const threshold = 160

  setInterval(() => {
    if (window.outerHeight - window.innerHeight > threshold ||
      window.outerWidth - window.innerWidth > threshold) {
      if (!devtools.open) {
        devtools.open = true
        console.warn('‚ö†Ô∏è Í∞úÎ∞úÏûê ÎèÑÍµ¨Í∞Ä Ïó¥Î†∏ÏùÑ Ïàò ÏûàÏäµÎãàÎã§')
        // TODO: ÎØºÍ∞êÌïú Îç∞Ïù¥ÌÑ∞ Î≥¥Ìò∏ Ï°∞Ïπò
      }
    } else {
      devtools.open = false
    }
  }, 500)
}

// ÎÑ§Ìä∏ÏõåÌÅ¨ Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë
const startNetworkMonitoring = () => {
  // Ï£ºÍ∏∞Ï†Å ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú ÌôïÏù∏
  networkCheckInterval = window.setInterval(checkNetworkConnection, 30000)

  // Î∏åÎùºÏö∞Ï†Ä Ïò®ÎùºÏù∏/Ïò§ÌîÑÎùºÏù∏ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  window.addEventListener('online', () => {
    showOfflineAlert.value = false
    ElNotification({
      title: 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ Î≥µÍµ¨',
      message: 'Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞Ïù¥ Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§.',
      type: 'success',
      duration: 3000
    })
  })

  window.addEventListener('offline', () => {
    showOfflineAlert.value = true
    ElNotification({
      title: 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÎÅäÍπÄ',
      message: 'Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.',
      type: 'warning',
      duration: 5000
    })
  })
}

// ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù (PWA)
const registerServiceWorker = async () => {
  if ('serviceWorker' in navigator && import.meta.env.PROD) {
    try {
      const registration = await navigator.serviceWorker.register('/sw.js')
      console.log('‚úÖ Service Worker Îì±Î°ù ÏÑ±Í≥µ:', registration)

      // ÏóÖÎç∞Ïù¥Ìä∏ Í∞êÏßÄ
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing
        if (newWorker) {
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // ÏÉà Î≤ÑÏ†Ñ ÏûàÏùå
              showUpdateNotification.value = true
            }
          })
        }
      })
    } catch (error) {
      console.warn('‚ö†Ô∏è Service Worker Îì±Î°ù Ïã§Ìå®:', error)
    }
  }
}

// Ïï± ÏÉàÎ°úÍ≥†Ïπ®
const reloadApp = () => {
  window.location.reload()
}

// Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏
onMounted(() => {
  initializeApp()
})

// Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏
onUnmounted(() => {
  if (networkCheckInterval) {
    clearInterval(networkCheckInterval)
  }
})
</script>

<style scoped>
#app {
  font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  color: #2c3e50;
  min-height: 100vh;
  background-color: #f5f7fa;
}

.loading-container {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
}

.loading-content {
  text-align: center;
  color: white;
  max-width: 400px;
  width: 100%;
}

.loading-icon {
  margin-bottom: 24px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.8;
    transform: scale(1.05);
  }
}

.loading-title {
  font-size: 2rem;
  font-weight: 700;
  margin: 0 0 16px 0;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.loading-text {
  font-size: 1rem;
  margin: 0 0 24px 0;
  opacity: 0.9;
  font-weight: 300;
}

.loading-progress {
  margin-top: 20px;
}

.loading-progress :deep(.el-progress-bar__outer) {
  background-color: rgba(255, 255, 255, 0.2);
}

.loading-progress :deep(.el-progress-bar__inner) {
  background: linear-gradient(90deg, #409EFF 0%, #67C23A 100%);
}

.offline-alert {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 9999;
  margin: 0;
  border-radius: 0;
  border: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Í∏ÄÎ°úÎ≤å Ïä§ÌÉÄÏùº */
:deep(.el-card) {
  border-radius: 12px;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

:deep(.el-button) {
  border-radius: 8px;
  font-weight: 500;
}

:deep(.el-input__wrapper) {
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

:deep(.el-form-item__label) {
  font-weight: 600;
  color: #303133;
}

/* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
@media (max-width: 480px) {
  .loading-container {
    padding: 16px;
  }

  .loading-title {
    font-size: 1.75rem;
  }

  .loading-text {
    font-size: 0.9rem;
  }
}

/* Îã§ÌÅ¨ Î™®Îìú ÎåÄÏùë */
@media (prefers-color-scheme: dark) {
  #app {
    background-color: #1a1a1a;
    color: #e5eaf3;
  }

  :deep(.el-form-item__label) {
    color: #e5eaf3;
  }
}

/* Ï†ëÍ∑ºÏÑ± Í∞úÏÑ† */
@media (prefers-reduced-motion: reduce) {
  .loading-icon,
  * {
    animation: none !important;
    transition: none !important;
  }
}

/* Í≥†ÎåÄÎπÑ Î™®Îìú */
@media (prefers-contrast: high) {
  :deep(.el-input__wrapper) {
    border: 2px solid #000;
  }

  :deep(.el-button) {
    border: 2px solid #000;
  }
}
</style>
